# Wireformat

[Wireformat](def://?inline)

WireFormat supports [JSON](https://json.org) and [Protocol Buffers](https://protobuf.dev) out of the box, 
protobuf being the default, JSON is provided for the faint-hearted.

## Wireformat implementations

Wireformat uses [wireformat implementations](def://) to serialize/deserialize data. These are classes
that implement the [WireFormat](class://) interface.

Each [wireformat implementation](def://) has a [supposedly unique](def://) [wireformat name](def://).

[Wireformat implementations](def://) are not meant to be coded manually:

* [Adaptive](def://) provides built-ins for primitive Kotlin data types, collections and datetime classes
* [adat classes](def://) have theirs automatically built from [adat metadata](def://)
* [services](def://) use only existing ones

As of now, [wireformat implementations](def://) have to be registered manually into the [wireformat registry](def://).

This is a limitation of the Kotlin compiler incremental compiling. While workarounds are possible, I don't know if
the effort to write them would be worth it.

See [writing an application module definition](guide://) for examples about how to register implementations.

## Wireformat for enum classes

Enum classes need a companion object for wireformat support. We might add a [compiler plugin](def://) feature
to generate this automatically later, but for now it has to be added manually:

[ExampleEnum](example://fun.adaptive.example)

## Polymorphism

WireFormat supports general polymorphism for types with `yes` in the Polymorph
column of the table below.

### Enums

Enums are particularly hard to polymorph as they do not have a class name easily
accessible. So you cannot use enums in a direct polymorphic context (when the enum
instance is the value of the polymorphic property).

### Null values in polymorphic collections

`null` values in polymorphic collections does not work. This is a corner case
that I really don't want to spend time on. For example, this code throws a
runtime error:

```kotlin
@Adat
class NotWorkingTest(
    val something : Any
)

fun NOT_WORKING() {
    PolymorphicTestClass(listOf(12, null)) // this throws an error during de-serialization
}
```

## Supported Data Types

The table below shows the data types supported by WireFormat serialization.

User-defined classes that have the WireFormat supertype will have a companion object
generated by the compiler plugin with WireFormatCompanion supertype and the appropriate
encoding/decoding methods.

| Type                            | Supported        | Polymorph |
|---------------------------------|------------------|-----------|
| **Kotlin Built-in**             |                  |           |
| kotlin.Any                      | yes              | yes       |
| T? (a.k.a. `null`)              | yes              | partial   |
| kotlin.Nothing                  | -                | -         |
| kotlin.Unit                     | yes (see note 1) | -         | 
| kotlin.Boolean                  | yes              | yes       |
| kotlin.Int                      | yes              | yes       |
| kotlin.Short                    | yes              | yes       |
| kotlin.Byte                     | yes              | yes       |
| kotlin.Long                     | yes              | yes       |
| kotlin.Float                    | yes              | yes       |
| kotlin.Double                   | yes              | yes       |
| kotlin.Char                     | yes              | yes       |
| kotlin.String                   | yes              | yes       | 
| kotlin.Enum<T>                  | yes              | -         |
| kotlin.Array<T>                 | -                | -         |
| kotlin.BooleanArray             | yes              | yes       |
| kotlin.IntArray                 | yes              | yes       |
| kotlin.ShortArray               | yes              | yes       |
| kotlin.ByteArray                | yes              | yes       |
| kotlin.LongArray                | yes              | yes       |
| kotlin.DoubleArray              | yes              | yes       |
| kotlin.FloatArray               | yes              | yes       |
| kotlin.CharArray                | yes              | yes       |
| kotlin.Iterator                 | -                | -         |
| kotlin.Throwable                | -                | -         |
| kotlin.Comparable               | -                | -         |
| kotlin.Function                 | -                | -         |
| **Kotlin Unsigned**             |                  |           | 
| UByte                           | yes              | yes       |
| UInt                            | yes              | yes       |
| UShort                          | yes              | yes       |
| ULong                           | yes              | yes       |
| UByteArray                      | yes              | yes       | 
| UShortArray                     | yes              | yes       |
| UIntArray                       | yes              | yes       |
| ULongArray                      | yes              | yes       |
| **Kotlin Collections**          |                  |           |
| kotlin.collections.Iterable     | -                | -         |
| kotlin.collections.Collection   | -                | -         |
| kotlin.collections.List         | yes              | yes       |
| kotlin.collections.MutableList  | yes              | maybe     |
| kotlin.collections.Set          | yes              | yes       |
| kotlin.collections.MutableSet   | yes              | maybe     |
| kotlin.collections.Map          | yes              | -         |
| kotlin.collections.MutableMap   | yes              | -         |
| kotlin.collections.ArrayDeque   | -                | -         | 
| **Kotlin Time**                 |                  |           |
| kotlin.time.Duration            | yes              | yes       |
| **kotlinx-datetime**            |                  |           |
| kotlinx.datetime.Instant        | yes              | yes       |
| kotlinx.datetime.Clock          | -                | -         |
| kotlinx.datetime.LocalDateTime  | yes              | yes       |
| kotlinx.datetime.LocalDate      | yes              | yes       |
| kotlinx.datetime.LocalTime      | yes              | yes       |
| kotlinx.datetime.TimeZone       | -                | -         |
| kotlinx.datetime.Month          | yes              | -         |
| kotlinx.datetime.DayOfWeek      | yes              | -         |
| kotlinx.datetime.DateTimePeriod | -                | -         |
| kotlinx.datetime.DatePeriod     | -                | -         |
| kotlinx.datetime.DateTimeUnit   | -                | -         |
| kotlinx.datetime.UtcOffset      | -                | -         |
| **Z2**                          |                  |           |
| fun.adaptive.utility.UUID<T>    | yes              | yes       |


## Arrays

Wireformat supports primitive arrays but does not support the generic `Array<T>`
type.

The problem with generic arrays is that on JVM they are actually strongly
typed. Which is in conflict with generics and is basically impossible to
resolve as the type information is basically lost:

```kotlin
val value = listOf(1, Array<AdaptiveInstruction>(1) { name("a")}, "B")
```

In this case the information that the array contains `AdaptiveInstruction` instances
is hidden by the generic of `listOf`. Value is `List<Any>` and it indeed can store
any values.

When generating the wireformat for `List<Any>` there is no type information
during compile time to rely on. While it is possible to get information about
the contained type with `getComponentType()` in Java, this function does not exist
on other [platforms](def://). So, if I create an array in Javascript for example, I cannot
serialize it with the type information. In result, I cannot de-serialize it with the
proper type information in Java.

I've spent some time on the generic array support and then decided to drop it and replace
generic arrays with lists or sets everywhere. This makes the situation clear and without
any "if this then that" conditions which would be hard to remember.

## See also

- [Low-level JSON](guide://)
- [Transform a JSON file](guide://)
- [Protobuf implementation details](guide://)